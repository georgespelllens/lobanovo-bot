{% extends "base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ ‚Äî –ü—Ä–∏—ë–º–Ω–∞—è –õ–æ–±–∞–Ω–æ–≤–∞{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>–ü—Ä–∏–≤–µ—Ç, {{ user.first_name or user.username }}! üëã</h1>
        <div class="level-badge level-{{ user.level }}">
            {% if user.level == 'kitten' %}üê± –ö–æ—Ç—ë–Ω–æ–∫
            {% elif user.level == 'wolfling' %}üê∫ –í–æ–ª—á–æ–Ω–æ–∫
            {% else %}üê∫üî• –í–æ–ª–∫{% endif %}
        </div>
    </div>

    <!-- Progress Section -->
    <div class="card-grid">
        <div class="card">
            <div class="card-header">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            <div class="card-body">
                <div class="stat-large">{{ user.xp }} XP</div>
                <div class="progress-bar">
                    {% if user.level == 'kitten' %}
                        {% set progress = (user.xp / 100 * 100)|int %}
                        {% set next_level = "–í–æ–ª—á–æ–Ω–æ–∫" %}
                        {% set xp_needed = 100 - user.xp %}
                    {% elif user.level == 'wolfling' %}
                        {% set progress = ((user.xp - 100) / 200 * 100)|int %}
                        {% set next_level = "–í–æ–ª–∫" %}
                        {% set xp_needed = 300 - user.xp %}
                    {% else %}
                        {% set progress = 100 %}
                        {% set next_level = "" %}
                        {% set xp_needed = 0 %}
                    {% endif %}
                    <div class="progress-fill" style="width: {{ [progress, 100]|min }}%"></div>
                </div>
                {% if next_level %}
                <p class="text-muted">–î–æ {{ next_level }}: {{ xp_needed }} XP</p>
                {% else %}
                <p class="text-muted">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">üìã –ó–∞–¥–∞–Ω–∏—è</div>
            <div class="card-body">
                <div class="stat-row">
                    <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ:</span>
                    <strong>{{ task_stats.completed }}</strong>
                </div>
                <div class="stat-row">
                    <span>–í—Å–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ:</span>
                    <strong>{{ task_stats.total }}</strong>
                </div>
                <div class="stat-row">
                    <span>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ XP:</span>
                    <strong>{{ task_stats.total_xp }}</strong>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üíé –ü–æ–¥–ø–∏—Å–∫–∞</div>
            <div class="card-body">
                <div class="stat-large">
                    {% if user.subscription_tier == 'free' %}Free üê±
                    {% elif user.subscription_tier == 'pro' %}Pro üê∫
                    {% else %}Premium üê∫üî•{% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Active Tasks -->
    {% if active_tasks %}
    <div class="section">
        <h2>üìã –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
        <div class="task-list">
            {% for task in active_tasks %}
            <div class="task-item task-{{ task.status }}">
                <div class="task-status">
                    {% if task.status == 'assigned' %}‚¨ú
                    {% elif task.status == 'submitted' %}üîÑ
                    {% elif task.status == 'completed' %}‚úÖ
                    {% else %}‚è≠{% endif %}
                </div>
                <div class="task-content">
                    <strong>{{ task.task_template.title if task.task_template else '–ó–∞–¥–∞–Ω–∏–µ' }}</strong>
                    {% if task.xp_earned %}
                    <span class="xp-badge">+{{ task.xp_earned }} XP</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Activity -->
    {% if recent_messages %}
    <div class="section">
        <h2>üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã</h2>
        <div class="message-list">
            {% for msg in recent_messages[-10:] %}
            <div class="message message-{{ msg.role }}">
                <div class="message-header">
                    {% if msg.role == 'user' %}üë§ –¢—ã{% else %}ü§ñ –ë–æ—Ç{% endif %}
                    <span class="message-time">{{ msg.created_at.strftime('%d.%m %H:%M') }}</span>
                </div>
                <div class="message-text">{{ msg.content[:300] }}{% if msg.content|length > 300 %}...{% endif %}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
