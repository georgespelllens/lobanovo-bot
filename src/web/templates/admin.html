{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ü—Ä–∏—ë–º–Ω–∞—è –õ–æ–±–∞–Ω–æ–≤–∞{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <h1>üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>

    <!-- Stats Overview -->
    <div class="card-grid">
        <div class="card">
            <div class="card-header">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="card-body">
                <div class="stat-large">{{ stats.total_users }}</div>
                <p class="text-muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö (7 –¥–Ω): {{ stats.active_users_7d }}</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è</div>
            <div class="card-body">
                <div class="stat-large">{{ stats.messages_today }}</div>
                <p class="text-muted">–°—Ä. –æ—Ü–µ–Ω–∫–∞: {{ stats.avg_rating or '‚Äî' }}</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üí∞ –ü—Ä—è–º–∞—è –ª–∏–Ω–∏—è</div>
            <div class="card-body">
                <div class="stat-large">{{ stats.direct_line_revenue_rub }}‚ÇΩ</div>
                <p class="text-muted">–í–æ–ø—Ä–æ—Å–æ–≤: {{ stats.direct_line_total }}</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</div>
            <div class="card-body">
                <div class="stat-large">{{ kb_stats.total }}</div>
                <p class="text-muted">–° —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º–∏: {{ kb_stats.with_embeddings }}</p>
            </div>
        </div>
    </div>

    <!-- Subscriptions -->
    <div class="card-grid">
        <div class="card">
            <div class="card-header">üìã –ü–æ–¥–ø–∏—Å–∫–∏</div>
            <div class="card-body">
                {% for tier, count in stats.subscriptions.items() %}
                <div class="stat-row">
                    <span>{{ tier|upper }}:</span>
                    <strong>{{ count }}</strong>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pending Direct Questions -->
    {% if direct_questions %}
    <div class="section">
        <h2>üé§ –ü—Ä—è–º–∞—è –ª–∏–Ω–∏—è ‚Äî –æ–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–í–æ–ø—Ä–æ—Å</th>
                        <th>–î–µ–¥–ª–∞–π–Ω</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dq in direct_questions %}
                    <tr>
                        <td>{{ dq.id }}</td>
                        <td>{{ dq.user_context.get('role', '?') }}</td>
                        <td>{{ (dq.question_text or dq.question_voice_transcript or '‚Äî')[:80] }}</td>
                        <td>{{ dq.deadline_at.strftime('%d.%m %H:%M') if dq.deadline_at else '‚Äî' }}</td>
                        <td><span class="badge badge-{{ dq.status }}">{{ dq.status }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Pending Escalations -->
    {% if escalations %}
    <div class="section">
        <h2>üîî –≠—Å–∫–∞–ª–∞—Ü–∏–∏</h2>
        <div class="escalation-list">
            {% for esc in escalations %}
            <div class="card">
                <div class="card-header">
                    #{{ esc.id }} | {{ esc.trigger_type }}
                    <span class="text-muted">{{ esc.created_at.strftime('%d.%m %H:%M') }}</span>
                </div>
                <div class="card-body">
                    <p>{{ esc.summary }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Users List -->
    <div class="section">
        <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50)</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>–£—Ä–æ–≤–µ–Ω—å</th>
                        <th>XP</th>
                        <th>–¢–∞—Ä–∏—Ñ</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users_list %}
                    <tr>
                        <td>@{{ u.username or '‚Äî' }}</td>
                        <td>{{ u.level }}</td>
                        <td>{{ u.xp }}</td>
                        <td>{{ u.subscription_tier }}</td>
                        <td>{{ u.last_interaction.strftime('%d.%m %H:%M') if u.last_interaction else '‚Äî' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
